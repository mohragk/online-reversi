<html>
    <head>
        <title>Reversi</title>
        <style>
            .red_circle, .green_circle {
                background-color: red;
            display:block;
            height:42px;
            width:42px;
            border-radius:50%;
           
            margin:auto;
            
            }
            .green_circle {
                background-color: green;
            }
        </style>
    </head>
    <body>
        <script src="/socket.io/socket.io.js"></script>
    </body>
        <script
            src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs="
            crossorigin="anonymous">
        </script>
      
      <div id= "main">
        <div id="player_data">Waiting for other player</div>
        <div id="player_score"></div>
        <canvas id="grid_canvas" width="720" height="720"></canvas>
      </div>
    

    <script>
        let socket
        let player_number
        let your_turn = false
        let cell_size_pixels = 48
        let mouse_position
        let player_score

        function drawCircle(context, x, y, radius) {
            context.beginPath();
            
            // Draws a circle of radius 20 at the coordinates 100,100 on the canvas
            const new_x = x + (0.5 * radius)
            const new_y = y + (0.5 * radius)
            context.arc(new_x, new_y, 0.5*radius, 0, Math.PI*2, true);
            context.closePath();
            context.fill();
        } 

        jQuery(document).ready(async function($) {

            socket = await io.connect('')


            var canvas = document.getElementById('grid_canvas');
            var ctx = canvas.getContext('2d');
           
            canvas.addEventListener('mousemove', function(e) {
                mouse_position = getMousePos(canvas, e);
            }, false);

            canvas.addEventListener("click", function(e) {
                
                
                // Convert mouse coords to grid coords
                const col = Math.floor(mouse_position.x / cell_size_pixels)
                const row = Math.floor(mouse_position.y / cell_size_pixels)

                if (e.button === 0) {
                    socket.emit('add_or_flip_coin', {row, col, player_number})
                }
                

            }, false);

            canvas.addEventListener('contextmenu', function(e) {
                // Convert mouse coords to grid coords
                const col = Math.floor(mouse_position.x / cell_size_pixels)
                const row = Math.floor(mouse_position.y / cell_size_pixels)
                socket.emit('remove_coin', {row, col})
            })

            window.addEventListener('keypress', function(e) {
                console.log(e.keyCode)
                if (e.keyCode === 115 || e.keyCode === 101 ) //s
                {
                    socket.emit('switch_to_other_player', player_number)
                }
            })

            function getMousePos(canvas, e) {
                var rect = canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
            
            socket.on('waiting', (msg)=> {
                console.log(msg)
            })

            socket.on('player_number', number => {
                player_number = number;
                const player_data = $('#player_data');
                
                let html = `<h4>You're the RED player - press E to end turn</h4>` 
                if (player_number == 1) {
                    html = `<h4>You're the RED player - press E to end turn</h4>`
                }
                else {
                    html = `<h4>You're the GREEN player - press E to end turn</h4>`
                }
                player_data.html(html)
            })

            socket.on('game_update', (game_state) => {

                const player_score_div = $('#player_score').text(`Score: ${player_score}` )

                if (game_state !== null) {
                    var canvas_w = canvas.width;
                    var canvas_h = canvas.height;
                    ctx.clearRect(0,0, canvas_w, canvas_h)

                    // reset
                    player_score = 0
                    
                    // update and draw grid
                    const { grid, grid_dim } = game_state
                    cell_size_pixels = canvas_h / grid_dim
                    for (let row = 0 ; row < grid_dim; row++) {
                        for (let col = 0 ; col < grid_dim; col++) {
                            const margin = 8
                            const half_margin = margin / 2
                            let x = col * cell_size_pixels + (0.5 * half_margin)
                            let y = row * cell_size_pixels + (0.5 * half_margin)
                            
                            const cell_value = grid[row * grid_dim + col]
                            if (cell_value === player_number) player_score++
                            ctx.fillStyle = 'black'
                            ctx.fillRect(x, y, cell_size_pixels - half_margin, cell_size_pixels - half_margin)
                            


                            x += 0.5 * half_margin
                            y += 0.5 * half_margin
                            if (cell_value == 1) {

                                ctx.fillStyle = 'red'
                                drawCircle(ctx, x, y, cell_size_pixels - margin)
                            }
                            else if (cell_value == 2) {
                                ctx.fillStyle = 'green' 
                                drawCircle(ctx, x, y, cell_size_pixels - margin)
                            }
                        }
                    }
                    
                    const is_your_turn = (game_state.current_player_number === player_number)
                    

                    
                    if (is_your_turn) {
                        // draw border
                        ctx.strokeStyle = player_number === 1 ? 'red' : 'green'
                        ctx.lineWidth = 8 * 4;
                        ctx.strokeRect(0,0, canvas_w, canvas_h )
                    }
                }
            })

            setInterval(
                () =>{
                    socket.emit('request_update')
                },
                200
            )
            

           
        })
    </script>
</html>